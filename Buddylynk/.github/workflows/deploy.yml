name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 30m
          envs: AWS_REGION,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,S3_BUCKET_NAME,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,JWT_SECRET
          script: |
            set -e
            echo "Starting deployment"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            cd ~/lakshmi_mata
            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            echo "Detecting project folder..."
            if [ -d "Buddylynk/Buddylynk" ]; then
              PROJECT_PATH="Buddylynk/Buddylynk"
            elif [ -d "Buddylynk_P2.6/Buddylynk" ]; then
              PROJECT_PATH="Buddylynk_P2.6/Buddylynk"
            else
              echo "Could not find project folder"
              exit 1
            fi
            echo "Found project at $PROJECT_PATH"
            NGINX_PATH="/home/ubuntu/lakshmi_mata/$PROJECT_PATH/client/dist"
            echo "Stopping PM2..."
            pm2 stop all || true
            pm2 delete all || true
            echo "Installing backend dependencies..."
            cd ~/lakshmi_mata/$PROJECT_PATH/server
            npm install --production --legacy-peer-deps
            echo "Building frontend..."
            cd ~/lakshmi_mata/$PROJECT_PATH/client
            npm install --legacy-peer-deps
            npm run build
            echo "Checking Redis..."
            if ! systemctl is-active --quiet redis-server; then
              sudo systemctl start redis-server
              sudo systemctl enable redis-server
            fi
            echo "Setting up environment..."
            cd ~/lakshmi_mata/$PROJECT_PATH/server
            echo "AWS_REGION=${AWS_REGION:-us-east-1}" > .env
            echo "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" >> .env
            echo "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" >> .env
            echo "S3_BUCKET_NAME=${S3_BUCKET_NAME:-buddylynk-media-bucket-2024}" >> .env
            echo "GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}" >> .env
            echo "PORT=5000" >> .env
            echo "JWT_SECRET=${JWT_SECRET}" >> .env
            echo "REDIS_HOST=localhost" >> .env
            echo "REDIS_PORT=6379" >> .env
            echo "NSFW_API_URL=http://35.227.39.141:8002/nsfw" >> .env
            echo "ENABLE_NSFW_CHECK=true" >> .env
            echo "RECOMMENDATION_API_URL=http://35.227.39.141:8001/recommend" >> .env
            echo "Starting backend..."
            pm2 start index.js --name buddylynk-server
            pm2 save
            chmod -R 755 ~/lakshmi_mata
            echo "Restarting Nginx..."
            sudo systemctl restart nginx
            echo "Deployment completed!"
            pm2 status
            echo "Zigzag algorithm and ML recommendations active!"
